<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á§æÂå∫Âú∞Âõæ‰ø°ÊÅØÊü•ËØ¢</title>
    <!-- html2canvasÂ∫ìÁî®‰∫éÊà™ÂõæÂäüËÉΩ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
                gap: 15px;
            }

            .info-panel {
                width: 100%;
                order: -1;
            }

            .map-container {
                min-height: 400px;
            }

            body {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 15px;
            }

            .map-controls {
                flex-wrap: wrap;
                gap: 8px;
            }

            .zoom-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        .map-container {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .map-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .zoom-btn {
            padding: 8px 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s, transform 0.2s;
        }

        .zoom-btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }

        .zoom-btn:active {
            transform: translateY(0);
        }

        .zoom-btn:disabled {
            background: #cccccc !important;
            cursor: not-allowed;
            transform: none;
        }

        .zoom-btn:disabled:hover {
            background: #cccccc !important;
            transform: none;
        }

        .zoom-level {
            color: #666;
            font-size: 14px;
            margin-left: 10px;
        }

        #map-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            position: relative;
            background: #fafafa;
        }

        #map-svg {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        /* Âú∞Âõæ‰∏äÁöÑ‰ø°ÊÅØÊòæÁ§∫Ê†∑Âºè */
        .map-info-overlay {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #9C27B0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            font-family: 'Microsoft YaHei', sans-serif;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
            z-index: 1000;
            max-width: 180px;
            min-width: 140px;
            cursor: move;
            user-select: none;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .map-info-overlay:hover {
            box-shadow: 0 6px 16px rgba(156, 39, 176, 0.4);
            transform: translateY(-2px);
        }

        .map-info-overlay.dragging {
            box-shadow: 0 8px 20px rgba(156, 39, 176, 0.5);
            transform: rotate(2deg) scale(1.05);
        }

        .map-info-title {
            font-weight: bold;
            font-size: 13px;
            color: #9C27B0;
            margin-bottom: 4px;
            border-bottom: 1px solid #E1BEE7;
            padding-bottom: 2px;
            cursor: move;
        }

        .map-info-item {
            margin: 2px 0;
            font-size: 11px;
            color: #333;
        }

        .map-info-label {
            color: #666;
            font-weight: normal;
        }

        .map-info-value {
            color: #333;
            font-weight: bold;
        }

        .map-info-total {
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #E1BEE7;
            font-weight: bold;
            color: #9C27B0;
            font-size: 12px;
        }

        /* ÂºïÁ∫øÊ†∑Âºè */
        .map-leader-line {
            stroke: #2196F3;
            stroke-width: 2;
            fill: none;
            pointer-events: none;
            stroke-dasharray: 5,3;
            opacity: 0.8;
        }

        .map-leader-dot {
            fill: #2196F3;
            stroke: white;
            stroke-width: 1.5;
            pointer-events: none;
        }

        .info-panel {
            width: 300px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .community-area {
            transition: fill 0.3s ease, stroke 0.3s ease;
        }

        .community-area:hover {
            fill: #FF9800 !important;
            opacity: 0.8;
            stroke: #F57C00;
            stroke-width: 2px;
        }

        .community-area.selected {
            fill: #4CAF50 !important;
            opacity: 0.9;
            stroke: #2E7D32;
            stroke-width: 2px;
        }

        .info-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #9C27B0;
            padding-bottom: 10px;
        }

        .info-item {
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
        }

        .info-value {
            color: #333;
            margin-left: 10px;
        }

        .no-data {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .loading {
            color: #666;
            text-align: center;
            padding: 20px;
        }

        .error {
            color: #f44336;
            text-align: center;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .file-upload-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .file-upload-area {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            display: inline-block;
        }

        .file-input-label:hover {
            background: #1976D2;
        }

        .file-status {
            color: #666;
            font-size: 14px;
        }

        .file-status.success {
            color: #4CAF50;
        }

        .file-status.error {
            color: #f44336;
        }

        .upload-progress {
            color: #FF9800;
        }
    </style>
</head>
<body>
    <h1>Á§æÂå∫Âú∞Âõæ‰ø°ÊÅØÊü•ËØ¢Á≥ªÁªü</h1>

    <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
    <div class="file-upload-section">
        <div class="file-upload-area">
            <div class="file-input-wrapper">
                <input type="file" id="excel-file-input" class="file-input" accept=".xlsx,.xls">
                <label for="excel-file-input" class="file-input-label">üìÅ ÈÄâÊã©ExcelÊñá‰ª∂</label>
            </div>
            <div id="file-status" class="file-status">
                ÂΩìÂâçÊñá‰ª∂: <span id="current-filename">Âä†ËΩΩ‰∏≠...</span>
                (<span id="community-count">-</span>‰∏™Á§æÂå∫/Êùë)
            </div>
        </div>
    </div>

    <div class="container">
        <div class="map-container">
            <div class="map-controls">
                <button class="zoom-btn" onclick="zoomIn()">ÊîæÂ§ß +</button>
                <button class="zoom-btn" onclick="zoomOut()">Áº©Â∞è -</button>
                <button class="zoom-btn" onclick="resetZoom()">ÈáçÁΩÆËßÜÂõæ</button>
                <button class="zoom-btn" onclick="fitToView()">ÈÄÇÂ∫îÁ™óÂè£</button>
                <span class="zoom-level">Áº©Êîæ: <span id="zoom-percentage">100%</span></span>
                <div style="margin-left: 20px; border-left: 2px solid #ddd; padding-left: 20px;">
                    <button class="zoom-btn" onclick="selectAll()" style="background: #4CAF50;">ÂÖ®ÈÄâ</button>
                    <button class="zoom-btn" onclick="clearAll()" style="background: #f44336;">Ê∏ÖÁ©∫</button>
                    <span class="zoom-level">Â∑≤ÈÄâ: <span id="selected-count">0</span>‰∏™</span>
                </div>
            </div>
            <div id="map-container">
                <!-- SVGÂú∞ÂõæÂ∞ÜÂú®ËøôÈáåÂä†ËΩΩ -->
            </div>
        </div>

        <div class="info-panel">
            <div class="info-title">Á§æÂå∫ÁªüËÆ°‰ø°ÊÅØ</div>
            <div id="community-info">
                <div class="no-data">ËØ∑ÁÇπÂáªÂú∞Âõæ‰∏äÁöÑÁ§æÂå∫/ÊùëÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØÔºåÊîØÊåÅÂ§öÈÄâ</div>
            </div>
        </div>
    </div>

    <script>
        let selectedCommunities = new Set();  // Â≠òÂÇ®Â§öÈÄâÁöÑÁ§æÂå∫
        let communityData = {};
        let currentZoom = 1;
        let mapSvg = null;
        let infoBoxes = new Map(); // Â≠òÂÇ®‰ø°ÊÅØÊ°ÜÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ
        let dragState = { isDragging: false, element: null, offsetX: 0, offsetY: 0 };
        let linesOverlay = null; // ÂºïÁ∫øË¶ÜÁõñÂ±Ç

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadSVGMap();
            loadCurrentFileInfo();
            loadCommunityData();
            setupFileUpload();
        });

        // ËÆæÁΩÆÊñá‰ª∂‰∏ä‰º†ÂäüËÉΩ
        function setupFileUpload() {
            const fileInput = document.getElementById('excel-file-input');
            fileInput.addEventListener('change', handleFileUpload);
        }

        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileStatus = document.getElementById('file-status');
            fileStatus.className = 'file-status upload-progress';
            fileStatus.innerHTML = '‰∏ä‰º†‰∏≠...';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    fileStatus.className = 'file-status success';
                    fileStatus.innerHTML = result.message;

                    // Êõ¥Êñ∞ÂΩìÂâçÊñá‰ª∂‰ø°ÊÅØ
                    document.getElementById('current-filename').textContent = result.filename;
                    document.getElementById('community-count').textContent = result.community_count;

                    // ÈáçÊñ∞Âä†ËΩΩÁ§æÂå∫Êï∞ÊçÆ
                    await loadCommunityData();

                    // Ê∏ÖÁ©∫ÂΩìÂâçÈÄâÊã©
                    clearAll();

                    console.log('Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºåÊï∞ÊçÆÂ∑≤Êõ¥Êñ∞');
                } else {
                    throw new Error(result.error || '‰∏ä‰º†Â§±Ë¥•');
                }
            } catch (error) {
                fileStatus.className = 'file-status error';
                fileStatus.innerHTML = `‰∏ä‰º†Â§±Ë¥•: ${error.message}`;
                console.error('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•:', error);
            }

            // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•ÔºåÂÖÅËÆ∏ÈáçÊñ∞ÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
            event.target.value = '';
        }

        // Âä†ËΩΩÂΩìÂâçÊñá‰ª∂‰ø°ÊÅØ
        async function loadCurrentFileInfo() {
            try {
                const response = await fetch('/api/current-file');
                const result = await response.json();

                if (response.ok) {
                    document.getElementById('current-filename').textContent = result.filename;
                    document.getElementById('community-count').textContent = result.community_count;

                    if (result.file_exists) {
                        document.getElementById('file-status').className = 'file-status success';
                    } else {
                        document.getElementById('file-status').className = 'file-status error';
                    }
                } else {
                    document.getElementById('file-status').className = 'file-status error';
                    document.getElementById('file-status').innerHTML = 'Ëé∑ÂèñÊñá‰ª∂‰ø°ÊÅØÂ§±Ë¥•';
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂΩìÂâçÊñá‰ª∂‰ø°ÊÅØÂ§±Ë¥•:', error);
                document.getElementById('file-status').className = 'file-status error';
                document.getElementById('file-status').innerHTML = 'Ëé∑ÂèñÊñá‰ª∂‰ø°ÊÅØÂ§±Ë¥•';
            }
        }

        // Áº©ÊîæÂäüËÉΩ
        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 5);
            applyZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.1);
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
        }

        function fitToView() {
            if (mapSvg) {
                const container = document.getElementById('map-container');
                const containerRect = container.getBoundingClientRect();
                const svgRect = mapSvg.getBoundingClientRect();

                // ËÆ°ÁÆóÂêàÈÄÇÁöÑÁº©ÊîæÊØî‰æãÔºåÁïôÂá∫‰∏Ä‰∫õËæπË∑ù
                const scaleX = (containerRect.width * 0.9) / svgRect.width;
                const scaleY = (containerRect.height * 0.9) / svgRect.height;
                currentZoom = Math.min(scaleX, scaleY);

                applyZoom();
            }
        }

        function applyZoom() {
            if (mapSvg) {
                mapSvg.style.transform = `scale(${currentZoom})`;
                updateZoomDisplay();

                // Áº©ÊîæÊó∂Êõ¥Êñ∞Âú∞Âõæ‰ø°ÊÅØÊòæÁ§∫
                setTimeout(() => {
                    updateAggregatedInfo();
                }, 100);
            }
        }

        function updateZoomDisplay() {
            const percentage = Math.round(currentZoom * 100);
            document.getElementById('zoom-percentage').textContent = percentage + '%';
        }

        // Â§öÈÄâÊéßÂà∂ÂäüËÉΩ
        function selectAll() {
            selectedCommunities.clear();
            const communityGroups = document.querySelectorAll('g[data-name*="Á§æÂå∫"], g[data-name*="Êùë"]');

            communityGroups.forEach(group => {
                const communityName = group.getAttribute('data-name');
                if (communityData[communityName]) {
                    selectedCommunities.add(communityName);
                    updateCommunityVisualState(communityName, true);
                }
            });

            updateAggregatedInfo();
        }

        function clearAll() {
            selectedCommunities.clear();
            const communityGroups = document.querySelectorAll('g[data-name*="Á§æÂå∫"], g[data-name*="Êùë"]');

            communityGroups.forEach(group => {
                const communityName = group.getAttribute('data-name');
                updateCommunityVisualState(communityName, false);
            });

            // ÂÆåÂÖ®Ê∏ÖÁêÜÊâÄÊúâ‰ø°ÊÅØÊ°ÜÂíåÂºïÁ∫ø
            clearAllInfoOverlays();

            updateAggregatedInfo();
        }

        function updateCommunityVisualState(communityName, isSelected) {
            const group = document.querySelector(`g[data-name="${communityName}"]`);
            if (group) {
                const paths = group.querySelectorAll('path');
                paths.forEach(path => {
                    path.classList.toggle('selected', isSelected);
                    if (isSelected) {
                        path.style.fill = '#4CAF50';
                        path.style.stroke = '#2E7D32';
                        path.style.strokeWidth = '2px';
                    } else {
                        path.style.fill = '#e0e0e0';
                        path.style.stroke = '';
                        path.style.strokeWidth = '';
                    }
                });
            }
        }

        // ÂàùÂßãÂåñÂºïÁ∫øË¶ÜÁõñÂ±Ç
        function initLinesOverlay() {
            if (!linesOverlay) {
                linesOverlay = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                linesOverlay.id = 'lines-overlay';
                linesOverlay.style.position = 'absolute';
                linesOverlay.style.top = '0';
                linesOverlay.style.left = '0';
                linesOverlay.style.width = '100%';
                linesOverlay.style.height = '100%';
                linesOverlay.style.pointerEvents = 'none';
                linesOverlay.style.zIndex = '999';
                document.getElementById('map-container').appendChild(linesOverlay);
            }
        }

        // Ê∏ÖÈô§ÊâÄÊúâÂºïÁ∫ø
        function clearAllLines() {
            if (linesOverlay) {
                // ÂÆåÂÖ®Ê∏ÖÁ©∫ÂºïÁ∫øË¶ÜÁõñÂ±Ç
                while (linesOverlay.firstChild) {
                    linesOverlay.removeChild(linesOverlay.firstChild);
                }
            }
        }

        // Ê∏ÖÈô§ÁâπÂÆöÁ§æÂå∫ÁöÑÂºïÁ∫ø
        function clearCommunityLine(communityName) {
            if (linesOverlay) {
                const groups = linesOverlay.querySelectorAll(`g[data-community="${communityName}"]`);
                groups.forEach(group => group.remove());
            }
        }

        // Ê∏ÖÈô§ÊâÄÊúâÂú∞Âõæ‰∏äÁöÑ‰ø°ÊÅØÊòæÁ§∫
        function clearMapInfoOverlays() {
            const container = document.getElementById('map-container');

            // Âè™Ê∏ÖÈô§‰∏çÂú®ÈÄâ‰∏≠ÂàóË°®‰∏≠ÁöÑ‰ø°ÊÅØÊ°Ü
            const existingOverlays = container.querySelectorAll('.map-info-overlay');
            existingOverlays.forEach(overlay => {
                const communityName = overlay.getAttribute('data-community');
                if (!selectedCommunities.has(communityName)) {
                    overlay.remove();
                    infoBoxes.delete(communityName);
                    clearCommunityLine(communityName);
                }
            });
        }

        // ÂÆåÂÖ®Ê∏ÖÈô§ÊâÄÊúâ‰ø°ÊÅØÊ°ÜÂíåÂºïÁ∫ø
        function clearAllInfoOverlays() {
            const container = document.getElementById('map-container');
            const existingOverlays = container.querySelectorAll('.map-info-overlay');
            existingOverlays.forEach(overlay => overlay.remove());
            clearAllLines();
            infoBoxes.clear();
        }

        // Ëé∑ÂèñSVGÂÖÉÁ¥†ÁöÑ‰∏≠ÂøÉÁÇπ
        function getElementCenter(element) {
            try {
                const bbox = element.getBBox();
                const svgRect = mapSvg.getBoundingClientRect();
                const containerRect = document.getElementById('map-container').getBoundingClientRect();

                // ËÆ°ÁÆóÁº©ÊîæÊØî‰æã
                const scaleX = svgRect.width / mapSvg.viewBox.baseVal.width;
                const scaleY = svgRect.height / mapSvg.viewBox.baseVal.height;

                // ËÆ°ÁÆó‰∏≠ÂøÉÁÇπÂú®ÂÆπÂô®‰∏≠ÁöÑ‰ΩçÁΩÆ
                const centerX = (bbox.x + bbox.width / 2) * scaleX * currentZoom + (containerRect.width - svgRect.width) / 2;
                const centerY = (bbox.y + bbox.height / 2) * scaleY * currentZoom + (containerRect.height - svgRect.height) / 2;

                return { x: centerX, y: centerY };
            } catch (e) {
                console.error('Error getting element center:', e);
                return { x: 100, y: 100 };
            }
        }

        // Ê£ÄÊü•‰∏§‰∏™Áü©ÂΩ¢ÊòØÂê¶ÈáçÂè†
        function isOverlapping(rect1, rect2) {
            return !(rect1.right < rect2.left ||
                    rect2.right < rect1.left ||
                    rect1.bottom < rect2.top ||
                    rect2.bottom < rect1.top);
        }

        // ÊâæÂà∞‰∏çÈáçÂè†ÁöÑ‰ΩçÁΩÆ
        function findNonOverlappingPosition(preferredX, preferredY, width, height, containerRect, excludeCommunity = null) {
            const margin = 10;
            const testRect = {
                left: preferredX,
                top: preferredY,
                right: preferredX + width,
                bottom: preferredY + height
            };

            // Ê£ÄÊü•ÊòØÂê¶‰∏éÁé∞Êúâ‰ø°ÊÅØÊ°ÜÈáçÂè†Ôºå‰ΩÜÊéíÈô§ÊåáÂÆöÁöÑÁ§æÂå∫ÔºàÈÄöÂ∏∏ÊòØËá™Ë∫´Ôºâ
            let hasOverlap = false;
            for (let [key, info] of infoBoxes) {
                if (key === excludeCommunity) continue;  // Ë∑≥ËøáÊåáÂÆöÁöÑÁ§æÂå∫
                if (isOverlapping(testRect, info.rect)) {
                    hasOverlap = true;
                    break;
                }
            }

            if (!hasOverlap) {
                return { x: preferredX, y: preferredY };
            }

            // Â¶ÇÊûúÈáçÂè†ÔºåÂ∞ùËØïÂú®Âè≥‰æßÊâæ‰ΩçÁΩÆ
            const positions = [
                // Âè≥‰æßÂå∫Âüü
                { x: containerRect.width - width - margin, y: preferredY },
                { x: containerRect.width - width - margin, y: preferredY + 100 },
                { x: containerRect.width - width - margin, y: preferredY - 100 },
                // Â∑¶‰æßÂå∫Âüü
                { x: margin, y: preferredY },
                { x: margin, y: preferredY + 100 },
                { x: margin, y: preferredY - 100 },
                // ‰∏ãÊñπÂå∫Âüü
                { x: preferredX, y: containerRect.height - height - margin },
                { x: preferredX + 100, y: containerRect.height - height - margin },
                { x: preferredX - 100, y: containerRect.height - height - margin },
            ];

            for (let pos of positions) {
                if (pos.x < margin || pos.y < margin ||
                    pos.x + width > containerRect.width - margin ||
                    pos.y + height > containerRect.height - margin) {
                    continue;
                }

                const testPos = {
                    left: pos.x,
                    top: pos.y,
                    right: pos.x + width,
                    bottom: pos.y + height
                };

                let overlap = false;
                for (let [key, info] of infoBoxes) {
                    if (key === excludeCommunity) continue;  // Ë∑≥ËøáÊåáÂÆöÁöÑÁ§æÂå∫
                    if (isOverlapping(testPos, info.rect)) {
                        overlap = true;
                        break;
                    }
                }

                if (!overlap) {
                    return pos;
                }
            }

            // Â¶ÇÊûúÈÉΩÈáçÂè†ÔºåËøîÂõû‰∏Ä‰∏™Â†ÜÂè†‰ΩçÁΩÆ
            return {
                x: containerRect.width - width - margin - (infoBoxes.size * 20),
                y: margin + (infoBoxes.size * 20)
            };
        }

        // ÂàõÂª∫Âú∞Âõæ‰∏äÁöÑ‰ø°ÊÅØÊòæÁ§∫
        function createMapInfoOverlay(communityName, center) {
            const data = communityData[communityName];
            if (!data || !data.columns) return null;

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®‰ø°ÊÅØÊ°Ü
            const container = document.getElementById('map-container');
            const existingOverlay = container.querySelector(`.map-info-overlay[data-community="${communityName}"]`);
            if (existingOverlay) {
                // Â¶ÇÊûúÂ∑≤ÁªèÂ≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû
                return existingOverlay;
            }

            const containerRect = container.getBoundingClientRect();
            const overlay = document.createElement('div');
            overlay.className = 'map-info-overlay';
            overlay.setAttribute('data-community', communityName);

            let totalPeople = 0;
            let infoHTML = `<div class="map-info-title">${data.name}</div>`;

            // ÊòæÁ§∫ÊúâÊï∞ÊçÆÁöÑÈ°πÁõÆ
            for (const [colName, colData] of Object.entries(data.columns)) {
                if (colData.people_count > 0) {
                    infoHTML += `
                        <div class="map-info-item">
                            <span class="map-info-label">${colName}:</span>
                            <span class="map-info-value">${colData.people_count}‰∫∫</span>
                        </div>
                    `;
                    totalPeople += colData.people_count;
                }
            }

            if (totalPeople > 0) {
                infoHTML += `<div class="map-info-total">ÊÄªËÆ°: ${totalPeople}‰∫∫</div>`;
            }

            overlay.innerHTML = infoHTML;

            // ËÆ°ÁÆóÂ∞∫ÂØ∏
            const overlayWidth = 160;
            const overlayHeight = 90;

            // ‰ºòÂÖàÊîæÂú®Âè≥‰æß
            let preferredX = containerRect.width - overlayWidth - 20;
            let preferredY = center.y - overlayHeight / 2;

            // Â¶ÇÊûú‰∏≠ÂøÉÁÇπÂú®Âè≥‰æßÔºåÂàôÊîæÂ∑¶‰æß
            if (center.x > containerRect.width * 0.7) {
                preferredX = 20;
            }

            // Á°Æ‰øùÂú®ÂÆπÂô®ËæπÁïåÂÜÖ
            preferredY = Math.max(10, Math.min(preferredY, containerRect.height - overlayHeight - 10));

            // ÊâæÂà∞‰∏çÈáçÂè†ÁöÑ‰ΩçÁΩÆ
            const position = findNonOverlappingPosition(preferredX, preferredY, overlayWidth, overlayHeight, containerRect, communityName);

            overlay.style.left = position.x + 'px';
            overlay.style.top = position.y + 'px';

            // Â≠òÂÇ®‰ΩçÁΩÆ‰ø°ÊÅØ
            const existingInfo = infoBoxes.get(communityName);
            infoBoxes.set(communityName, {
                element: overlay,
                rect: {
                    left: position.x,
                    top: position.y,
                    right: position.x + overlayWidth,
                    bottom: position.y + overlayHeight
                },
                center: center,
                clickPosition: existingInfo ? existingInfo.clickPosition : center,  // ‰øùÁïôÁÇπÂáª‰ΩçÁΩÆ
                isManuallyMoved: false  // Ê∑ªÂä†ÊâãÂä®ÁßªÂä®Ê†áËÆ∞
            });

            // Ê∑ªÂä†ÊãñÊãΩ‰∫ã‰ª∂
            makeDraggable(overlay, communityName);

            container.appendChild(overlay);

            // ÂàõÂª∫ÂºïÁ∫ø - ‰ΩøÁî®ÁÇπÂáª‰ΩçÁΩÆ‰Ωú‰∏∫Ëµ∑ÁÇπ
            const lineStartPoint = existingInfo && existingInfo.clickPosition ? existingInfo.clickPosition : center;
            createLeaderLine(lineStartPoint, { x: position.x + overlayWidth / 2, y: position.y + overlayHeight / 2 }, communityName);

            return overlay;
        }

        // ÂàõÂª∫ÂºïÁ∫ø
        function createLeaderLine(fromCenter, toCenter, communityName) {
            if (!linesOverlay) {
                initLinesOverlay();
            }

            // ÂÖàÊ∏ÖÈô§ËØ•Á§æÂå∫ÁöÑÁé∞ÊúâÂºïÁ∫ø
            clearCommunityLine(communityName);

            // ÁÆÄÂåñÂùêÊ†áËÆ°ÁÆó - Áõ¥Êé•‰ΩøÁî®ÂÆπÂô®ÂùêÊ†á
            const fromX = fromCenter.x;
            const fromY = fromCenter.y;
            const toX = toCenter.x;
            const toY = toCenter.y;

            // ÂàõÂª∫ÂºïÁ∫øÁªÑÔºåÊñπ‰æøÁÆ°ÁêÜ
            const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
            group.setAttribute("data-community", communityName);

            // ÂàõÂª∫ÂºïÁ∫ø
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", fromX);
            line.setAttribute("y1", fromY);
            line.setAttribute("x2", toX);
            line.setAttribute("y2", toY);
            line.setAttribute("stroke", "#2196F3");
            line.setAttribute("stroke-width", "2");
            line.setAttribute("stroke-dasharray", "5,3");
            line.setAttribute("opacity", "0.8");

            // ÂàõÂª∫Ëµ∑ÁÇπÂúÜÁÇπ
            const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            dot.setAttribute("cx", fromX);
            dot.setAttribute("cy", fromY);
            dot.setAttribute("r", "4");
            dot.setAttribute("fill", "#2196F3");
            dot.setAttribute("stroke", "white");
            dot.setAttribute("stroke-width", "1.5");

            group.appendChild(line);
            group.appendChild(dot);
            linesOverlay.appendChild(group);
        }

        // ‰ΩøÂÖÉÁ¥†ÂèØÊãñÊãΩ
        function makeDraggable(element, communityName) {
            element.addEventListener('mousedown', function(e) {
                e.preventDefault();
                dragState.isDragging = true;
                dragState.element = element;
                dragState.communityName = communityName;
                dragState.offsetX = e.clientX - element.offsetLeft;
                dragState.offsetY = e.clientY - element.offsetTop;

                element.classList.add('dragging');
                document.body.style.cursor = 'grabbing';
            });
        }

        // Ê∑ªÂä†ÂÖ®Â±ÄÈº†Ê†á‰∫ã‰ª∂
        document.addEventListener('mousemove', function(e) {
            if (dragState.isDragging && dragState.element) {
                const container = document.getElementById('map-container');
                const containerRect = container.getBoundingClientRect();

                let newX = e.clientX - dragState.offsetX;
                let newY = e.clientY - dragState.offsetY;

                // ÈôêÂà∂Âú®ÂÆπÂô®ËæπÁïåÂÜÖ
                const elementRect = dragState.element.getBoundingClientRect();
                newX = Math.max(5, Math.min(newX, containerRect.width - elementRect.width - 5));
                newY = Math.max(5, Math.min(newY, containerRect.height - elementRect.height - 5));

                dragState.element.style.left = newX + 'px';
                dragState.element.style.top = newY + 'px';

                // Êõ¥Êñ∞Â≠òÂÇ®ÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ
                const info = infoBoxes.get(dragState.communityName);
                if (info) {
                    info.rect.left = newX;
                    info.rect.top = newY;
                    info.rect.right = newX + elementRect.width;
                    info.rect.bottom = newY + elementRect.height;

                    // Êõ¥Êñ∞ÂºïÁ∫ø - ‰ΩøÁî®Â≠òÂÇ®ÁöÑÁÇπÂáª‰ΩçÁΩÆ‰Ωú‰∏∫Ëµ∑ÁÇπ
                    const newCenter = {
                        x: newX + elementRect.width / 2,
                        y: newY + elementRect.height / 2
                    };
                    const lineStartPoint = info.clickPosition || info.center;
                    createLeaderLine(lineStartPoint, newCenter, dragState.communityName);
                }
            }
        });

        document.addEventListener('mouseup', function(e) {
            if (dragState.isDragging) {
                dragState.element.classList.remove('dragging');

                // Ê†áËÆ∞ËØ•‰ø°ÊÅØÊ°Ü‰∏∫ÊâãÂä®ÁßªÂä®ËøáÁöÑ
                const info = infoBoxes.get(dragState.communityName);
                if (info) {
                    info.isManuallyMoved = true;
                }

                dragState.isDragging = false;
                dragState.element = null;
                dragState.communityName = null;
                document.body.style.cursor = 'default';
            }
        });

        // Âä†ËΩΩSVGÂú∞Âõæ
        function loadSVGMap() {
            fetch('/static/Âú∞ÂõæÁ∫øÁ®ø.svg')
                .then(response => response.text())
                .then(svgText => {
                    const mapContainer = document.getElementById('map-container');
                    mapContainer.innerHTML = svgText;

                    // Ëé∑ÂèñSVGÂÖÉÁ¥†ÂºïÁî®
                    mapSvg = mapContainer.querySelector('svg');
                    if (mapSvg) {
                        mapSvg.id = 'map-svg';

                        // ÂàùÂßãÂåñÊó∂Ëá™Âä®ÈÄÇÂ∫îÁ™óÂè£
                        setTimeout(() => {
                            fitToView();
                        }, 100);
                    }

                    // ‰∏∫ÊØè‰∏™Á§æÂå∫Âå∫ÂüüÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    const communityGroups = document.querySelectorAll('g[data-name*="Á§æÂå∫"], g[data-name*="Êùë"]');
                    communityGroups.forEach(group => {
                        const communityName = group.getAttribute('data-name');

                        // ‰∏∫ÊâÄÊúâË∑ØÂæÑÊ∑ªÂä†Ê†∑ÂºèÁ±ª
                        const paths = group.querySelectorAll('path');
                        paths.forEach(path => {
                            path.classList.add('community-area');
                            path.style.fill = '#e0e0e0';
                            path.style.cursor = 'pointer';
                        });

                        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                        group.addEventListener('click', function(e) {
                            // ËÆ°ÁÆóÁÇπÂáª‰ΩçÁΩÆÁõ∏ÂØπ‰∫éÂÆπÂô®ÁöÑÂùêÊ†á
                            const containerRect = document.getElementById('map-container').getBoundingClientRect();
                            const svgRect = mapSvg.getBoundingClientRect();

                            // ËÆ°ÁÆóÁõ∏ÂØπ‰∫éÂÆπÂô®ÁöÑÁÇπÂáª‰ΩçÁΩÆ
                            const clickX = e.clientX - containerRect.left;
                            const clickY = e.clientY - containerRect.top;

                            toggleCommunitySelection(communityName, { x: clickX, y: clickY });
                        });

                        // Ê∑ªÂä†ÊÇ¨ÂÅúÊèêÁ§∫
                        group.setAttribute('title', communityName);
                    });

                    // Ê∑ªÂä†Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂ÁöÑÂìçÂ∫î
                    window.addEventListener('resize', function() {
                        setTimeout(fitToView, 100);
                    });
                })
                .catch(error => {
                    console.error('Âä†ËΩΩSVGÂú∞ÂõæÂ§±Ë¥•:', error);
                    document.getElementById('map-container').innerHTML =
                        '<div class="error">Âú∞ÂõæÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®</div>';
                });
        }

        // Âä†ËΩΩÊâÄÊúâÁ§æÂå∫Êï∞ÊçÆ
        function loadCommunityData() {
            fetch('/api/communities')
                .then(response => response.json())
                .then(data => {
                    communityData = data;
                    console.log('Á§æÂå∫Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', data);
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÁ§æÂå∫Êï∞ÊçÆÂ§±Ë¥•:', error);
                });
        }

        // ÂàáÊç¢Á§æÂå∫ÈÄâÊã©Áä∂ÊÄÅ
        function toggleCommunitySelection(communityName, clickPosition = null) {
            if (selectedCommunities.has(communityName)) {
                selectedCommunities.delete(communityName);
                updateCommunityVisualState(communityName, false);
            } else {
                selectedCommunities.add(communityName);
                updateCommunityVisualState(communityName, true);

                // Â¶ÇÊûúÊèê‰æõ‰∫ÜÁÇπÂáª‰ΩçÁΩÆÔºåÂ≠òÂÇ®ÂÆÉ
                if (clickPosition) {
                    const existingInfo = infoBoxes.get(communityName);
                    if (existingInfo) {
                        existingInfo.clickPosition = clickPosition;
                    } else {
                        // Â¶ÇÊûú‰ø°ÊÅØÊ°ÜËøò‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂Â≠òÂÇ®
                        infoBoxes.set(communityName, { clickPosition: clickPosition });
                    }
                }
            }

            updateAggregatedInfo();
        }

        // Êõ¥Êñ∞ËÅöÂêà‰ø°ÊÅØÊòæÁ§∫
        function updateAggregatedInfo() {
            const infoDiv = document.getElementById('community-info');
            const selectedCountSpan = document.getElementById('selected-count');

            selectedCountSpan.textContent = selectedCommunities.size;

            // Ê∏ÖÈô§Âú∞Âõæ‰∏äÁöÑ‰ø°ÊÅØÊòæÁ§∫
            clearMapInfoOverlays();

            if (selectedCommunities.size === 0) {
                infoDiv.innerHTML = '<div class="no-data">ËØ∑ÁÇπÂáªÂú∞Âõæ‰∏äÁöÑÁ§æÂå∫/ÊùëÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØÔºåÊîØÊåÅÂ§öÈÄâ</div>';
                return;
            }

            // ÊòæÁ§∫Âú∞Âõæ‰∏äÁöÑ‰ø°ÊÅØ
            selectedCommunities.forEach(communityName => {
                const group = document.querySelector(`g[data-name="${communityName}"]`);
                if (group && communityData[communityName]) {
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®‰∏îË¢´ÊâãÂä®ÁßªÂä®Ëøá
                    const existingInfo = infoBoxes.get(communityName);
                    if (existingInfo && existingInfo.isManuallyMoved && existingInfo.element && existingInfo.element.parentNode) {
                        // Â¶ÇÊûú‰ø°ÊÅØÊ°ÜË¢´ÊâãÂä®ÁßªÂä®Ëøá‰∏îËøòÂú®DOM‰∏≠ÔºåË∑≥ËøáÂàõÂª∫
                        return;
                    }

                    // ‰ΩøÁî®ÁÇπÂáª‰ΩçÁΩÆ‰Ωú‰∏∫ÂºïÁ∫øËµ∑ÁÇπÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®Âå∫Âüü‰∏≠ÂøÉ
                    let center;
                    if (existingInfo && existingInfo.clickPosition) {
                        center = existingInfo.clickPosition;
                    } else {
                        center = getElementCenter(group);
                    }

                    createMapInfoOverlay(communityName, center);
                }
            });

            if (selectedCommunities.size === 1) {
                // ÂçïÈÄâÊó∂ÊòæÁ§∫ËØ¶ÁªÜ‰ø°ÊÅØ
                const communityName = Array.from(selectedCommunities)[0];
                showSingleCommunityInfo(communityName);
                return;
            }

            // Â§öÈÄâÊó∂ÊòæÁ§∫ËÅöÂêà‰ø°ÊÅØ
            showAggregatedInfo();
        }

        // ÊòæÁ§∫Âçï‰∏™Á§æÂå∫‰ø°ÊÅØ
        function showSingleCommunityInfo(communityName) {
            const infoDiv = document.getElementById('community-info');

            if (communityData[communityName]) {
                const data = communityData[communityName];

                let infoHTML = `
                    <div class="info-item">
                        <span class="info-label">ÂêçÁß∞:</span>
                        <span class="info-value">${data.name}</span>
                    </div>
                `;

                // ‰ΩøÁî®Âä®ÊÄÅÂàóÂêçÊòæÁ§∫Êï∞ÊçÆ
                if (data.columns) {
                    for (const [colName, colData] of Object.entries(data.columns)) {
                        if (colData.raw_data !== '0' && colData.raw_data !== 'nan') {
                            infoHTML += `
                                <div class="info-item">
                                    <span class="info-label">${colName}:</span>
                                    <span class="info-value">${colData.raw_data} (‰∫∫Êï∞: ${colData.people_count})</span>
                                </div>
                            `;
                        }
                    }

                    // ËÆ°ÁÆóÊÄª‰∫∫Êï∞
                    const totalPeople = Object.values(data.columns).reduce((sum, col) => sum + col.people_count, 0);

                    infoHTML += `
                        <div class="info-item" style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px;">
                            <span class="info-label">ÊÄª‰∫∫Êï∞:</span>
                            <span class="info-value" style="font-weight: bold; color: #2196F3;">${totalPeople}‰∫∫</span>
                        </div>
                    `;
                }

                infoDiv.innerHTML = infoHTML;
            }
        }

        // ÊòæÁ§∫ËÅöÂêà‰ø°ÊÅØ
        function showAggregatedInfo() {
            const infoDiv = document.getElementById('community-info');
            const selectedNames = Array.from(selectedCommunities);

            // ËÆ°ÁÆóËÅöÂêàÊï∞ÊçÆ
            const aggregatedData = {};
            let totalPeople = 0;

            // Ëé∑ÂèñÊâÄÊúâÂèØËÉΩÁöÑÂàóÂêç
            const allColumns = new Set();
            selectedNames.forEach(name => {
                const data = communityData[name];
                if (data && data.columns) {
                    Object.keys(data.columns).forEach(col => allColumns.add(col));
                }
            });

            // ËÅöÂêàÊØè‰∏™ÂàóÁöÑÊï∞ÊçÆ
            allColumns.forEach(colName => {
                aggregatedData[colName] = {
                    total_people: 0,
                    communities: []
                };

                selectedNames.forEach(name => {
                    const data = communityData[name];
                    if (data && data.columns && data.columns[colName]) {
                        const colData = data.columns[colName];
                        aggregatedData[colName].total_people += colData.people_count;
                        if (colData.people_count > 0) {
                            aggregatedData[colName].communities.push({
                                name: name,
                                count: colData.people_count,
                                raw: colData.raw_data
                            });
                        }
                    }
                });

                totalPeople += aggregatedData[colName].total_people;
            });

            // ÁîüÊàêÊòæÁ§∫HTML
            let infoHTML = `
                <div class="info-item" style="background: #e3f2fd; border-left: 4px solid #2196F3;">
                    <span class="info-label">ËÅöÂêàÁªüËÆ° (${selectedNames.length}‰∏™Âú∞Âå∫):</span>
                    <span class="info-value">${selectedNames.join('„ÄÅ')}</span>
                </div>
            `;

            // ÊòæÁ§∫ÂêÑÁ±ªÂà´ÁöÑËÅöÂêàÁªüËÆ°
            for (const [colName, colData] of Object.entries(aggregatedData)) {
                if (colData.total_people > 0) {
                    infoHTML += `
                        <div class="info-item">
                            <span class="info-label">${colName}:</span>
                            <span class="info-value" style="font-weight: bold;">${colData.total_people}‰∫∫</span>
                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                ${colData.communities.map(c => `${c.name}: ${c.count}‰∫∫`).join(' | ')}
                            </div>
                        </div>
                    `;
                }
            }

            infoHTML += `
                <div class="info-item" style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; background: #f3e5f5;">
                    <span class="info-label">ÊÄªËÆ°‰∫∫Êï∞:</span>
                    <span class="info-value" style="font-weight: bold; color: #9C27B0; font-size: 18px;">${totalPeople}‰∫∫</span>
                </div>
            `;

            infoDiv.innerHTML = infoHTML;
        }


    </script>
</body>
</html>